<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Matrix Multiplier</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <style>
      .matrix-panel {
          background-color: #ffffff;
          border: 1px solid #ddd;
          box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
          margin-bottom: 15px;
          padding: 15px;
          border-radius: 5px;
      }
      .matrix-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }
      .matrix-size select {
          margin-right: 5px;
      }
      .matrix-grid table {
          width: 100%;
      }
      .matrix-grid input {
          text-align: center;
          width: 100%;
          border: 1px solid #ccc;
          padding: 5px;
      }
      #expression-frame {
          font-size: 1.2rem;
          text-align: center;
          padding: 10px;
          border-radius: 5px;
          background-color: #fff;
          box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1);
      }
    </style>
</head>
<body>
<div class="container-fluid" style="background-color:#e0e0e0; padding:20px;">
    <h1 class="mt-4 text-center mb-4">Matrix Multiplier</h1>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-danger">
          {% for msg in messages %}
            <div>{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    <form method="post" id="matrixForm" onsubmit="populateAllHidden()">
    <div class="row">
        <!-- Left panel: Matrix entry fields -->
        <div class="col-md-6" id="matrix-fields">
            <!-- Initially add two matrix panels with grid inputs -->
            <div class="matrix-panel" id="matrix-panel-1">
                <div class="matrix-header">
                    <strong>Matrix 1:</strong>
                    <!-- No remove button for first panel -->
                </div>
                <div class="matrix-size mb-2">
                    Rows: 
                    <select onchange="updateMatrixGrid(1)" id="rows-1">
                        <option>1</option>
                        <option>2</option>
                        <option selected>3</option>
                        <option>4</option>
                        <option>5</option>
                    </select>
                    Columns: 
                    <select onchange="updateMatrixGrid(1)" id="cols-1">
                        <option>1</option>
                        <option>2</option>
                        <option selected>3</option>
                        <option>4</option>
                        <option>5</option>
                    </select>
                </div>
                <div class="matrix-grid" id="grid-1">
                    <!-- Grid will be generated by JS -->
                </div>
                <input type="hidden" name="matrix1" id="hidden-1">
            </div>
            <div class="matrix-panel" id="matrix-panel-2">
                <div class="matrix-header">
                    <strong>Matrix 2:</strong>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeMatrixField(2)">X</button>
                </div>
                <div class="matrix-size mb-2">
                    Rows: 
                    <select onchange="updateMatrixGrid(2)" id="rows-2">
                        <option>1</option>
                        <option>2</option>
                        <option selected>3</option>
                        <option>4</option>
                        <option>5</option>
                    </select>
                    Columns: 
                    <select onchange="updateMatrixGrid(2)" id="cols-2">
                        <option>1</option>
                        <option>2</option>
                        <option selected>3</option>
                        <option>4</option>
                        <option>5</option>
                    </select>
                </div>
                <div class="matrix-grid" id="grid-2">
                    <!-- Grid will be generated by JS -->
                </div>
                <input type="hidden" name="matrix2" id="hidden-2">
            </div>
            <!-- Place the Add Matrix button as the last child -->
            <button type="button" class="btn btn-success mb-3" id="add-matrix-btn" onclick="addMatrixField()"> + Add Matrix </button>
        </div>
        <!-- Right panel: Result and Controls -->
        <div class="col-md-6">
            <div class="mb-3">
                <h4>Expression:</h4>
                <div id="expression-frame">
                    <!-- Updated by updateExpression() -->
                    ... 
                </div>
            </div>
            <div class="mb-3">
                <h4>Result:</h4>
                <div id="result-matrix-frame" style="min-height:150px;" class="bg-white p-3 border rounded">
                    {% if result_latex %}
                      <p class="result mb-0"><strong>$$ {{ result_latex }} $$</strong></p>
                    {% endif %}
                    {% if result_text %}
                      <!-- Hidden element for copy function -->
                      <span id="result-hidden" style="display:none;">{{ result_text }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="mb-3">
                <label for="operation">Operation:</label>
                <select name="operation" class="form-control" id="operation" onchange="updateExpression()">
                    <option value="Multiply">Multiply</option>
                    <option value="Add">Add</option>
                    <option value="Subtract">Subtract</option>
                    <option value="Transpose">Transpose</option>
                    <option value="Conjugate">Conjugate</option>
                </select>
            </div>
            <div class="mb-3">
                <button type="button" class="btn btn-warning" onclick="fillEmpty()">Fill Empty with 0</button>
                <button type="button" class="btn btn-info" onclick="copyResult()">Copy Result</button>
                <select id="special-matrix" class="form-control d-inline-block w-auto" onchange="addSpecialMatrix(this.value)">
                    <option value="">Select Special Matrix</option>
                    <option value="Pauli X">Pauli X</option>
                    <option value="Pauli Y">Pauli Y</option>
                    <option value="Pauli Z">Pauli Z</option>
                    <option value="Hadamard">Hadamard</option>
                    <option value="CNOT">CNOT</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Compute</button>
        </div>
    </div>
    </form>
</div>
<script>
// Make the passed matrix values available (if any)
var matrixValues = {{ matrix_values|tojson }};
var matrixCount = Object.keys(matrixValues).length || 2; // use posted panels; default=2

// Function to create grid (unchanged)
function createMatrixGrid(panelId, rows, cols, prefill) {
    var html = '<table class="table table-bordered mb-0">';
    for (var i = 0; i < rows; i++) {
        html += '<tr>';
        for (var j = 0; j < cols; j++) {
            var value = (prefill && prefill[i] && prefill[i][j] !== undefined) ? prefill[i][j] : "";
            html += '<td><input type="text" value="'+ value +'"></td>';
        }
        html += '</tr>';
    }
    html += '</table>';
    document.getElementById("grid-" + panelId).innerHTML = html;
}

// Modified updateMatrixGrid accepts an optional prefill array.
function updateMatrixGrid(panelId, prefill) {
    if (prefill) {
        var rows = prefill.length;
        var cols = prefill[0].length;
        document.getElementById("rows-" + panelId).value = rows;
        document.getElementById("cols-" + panelId).value = cols;
        createMatrixGrid(panelId, rows, cols, prefill);
    } else {
        var rows = parseInt(document.getElementById("rows-" + panelId).value);
        var cols = parseInt(document.getElementById("cols-" + panelId).value);
        createMatrixGrid(panelId, rows, cols);
    }
    updateExpression();
}

// On page load, if matrixValues exists, repopulate corresponding grids.
window.onload = function() {
    for (var key in matrixValues) {
        if (matrixValues.hasOwnProperty(key)) {
            var panelNum = key.replace("matrix", "");
            var valStr = matrixValues[key];
            if(valStr) {
                var prefill = valStr.split("\n").map(function(row) {
                    return row.trim().split(/\s+/);
                });
                updateMatrixGrid(parseInt(panelNum), prefill);
            }
        }
    }
    // Ensure grids are generated for panels without prefill
    for (var i = 1; i <= matrixCount; i++) {
        if (!matrixValues.hasOwnProperty("matrix" + i)) {
            updateMatrixGrid(i);
        }
    }
};

// addMatrixField() now inserts new panel before the Add Matrix button.
function addMatrixField() {
    matrixCount++;
    var container = document.getElementById("matrix-fields");
    var div = document.createElement("div");
    div.className = "matrix-panel";
    div.id = "matrix-panel-" + matrixCount;
    div.innerHTML = '<div class="matrix-header">'+
                    '<strong>Matrix ' + matrixCount + ':</strong>'+
                    '<button type="button" class="btn btn-danger btn-sm" onclick="removeMatrixField('+ matrixCount +')">X</button>'+
                    '</div>'+
                    '<div class="matrix-size mb-2">'+
                    'Rows: <select onchange="updateMatrixGrid('+ matrixCount +')" id="rows-'+ matrixCount +'">'+
                    '<option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>'+
                    '</select> Columns: <select onchange="updateMatrixGrid('+ matrixCount +')" id="cols-'+ matrixCount +'">'+
                    '<option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>'+
                    '</select>'+
                    '</div>'+
                    '<div class="matrix-grid" id="grid-'+ matrixCount +'"></div>'+
                    '<input type="hidden" name="matrix'+ matrixCount +'" id="hidden-'+ matrixCount +'">';
    var addButton = document.getElementById("add-matrix-btn");
    container.insertBefore(div, addButton);
    updateMatrixGrid(matrixCount);
    updateExpression();
}

function removeMatrixField(index) {
    var panel = document.getElementById("matrix-panel-" + index);
    if (panel) { panel.remove(); }
    var panels = document.querySelectorAll('[id^="matrix-panel-"]');
    for (var i = 0; i < panels.length; i++) {
        var newNum = i + 1;
        panels[i].id = "matrix-panel-" + newNum;
        panels[i].querySelector('.matrix-header strong').innerText = "Matrix " + newNum + ":";
        panels[i].querySelector('input[type="hidden"]').name = "matrix" + newNum;
        var rowSel = panels[i].querySelector('.matrix-size select:first-of-type');
        rowSel.id = "rows-" + newNum;
        var colSel = panels[i].querySelector('.matrix-size select:last-of-type');
        colSel.id = "cols-" + newNum;
        var gridDiv = panels[i].querySelector('.matrix-grid');
        gridDiv.id = "grid-" + newNum;
    }
    matrixCount = panels.length;
    updateExpression();
}

function fillEmpty() {
    for (var i = 1; i <= matrixCount; i++) {
        var inputs = document.getElementById("grid-" + i).getElementsByTagName("input");
        Array.from(inputs).forEach(function(input) {
            if (input.value.trim() === "") { input.value = "0"; }
        });
    }
}

function copyResult() {
    var resultHidden = document.getElementById("result-hidden");
    if (!resultHidden || resultHidden.textContent.trim() === "") {
        alert("No result available to copy!");
        return;
    }
    // Insert new panel before the Add Matrix button.
    addMatrixField();
    var newPanelId = matrixCount;
    var resultText = resultHidden.textContent.trim();
    var prefill = [];
    // If in sympy Matrix format, extract inner array string.
    if (resultText.startsWith("Matrix(")) {
        var inner = resultText.slice(7, -1).trim();
        // Remove outer brackets if present.
        if (inner.startsWith("[") && inner.endsWith("]")) {
            inner = inner.slice(1, -1);
        }
        // Split rows on "],[".
        var rowsStr = inner.split(/\],\s*\[/);
        prefill = rowsStr.map(function(row) {
            // Remove any stray brackets.
            row = row.replace(/[\[\]]/g, '');
            return row.split(',').map(function(cell) {
                return cell.trim();
            });
        });
    } else {
        // Fallback: assume newline separated values.
        var rows = resultText.split("\n");
        prefill = rows.map(function(r) { return r.trim().split(/\s+/); });
    }
    var rowCount = prefill.length;
    var colCount = (prefill[0] && prefill[0].length) || 0;
    document.getElementById("rows-" + newPanelId).value = rowCount;
    document.getElementById("cols-" + newPanelId).value = colCount;
    createMatrixGrid(newPanelId, rowCount, colCount, prefill);
    updateExpression();
}

function addSpecialMatrix(value) {
    if (value === "") return;
    var specialMatrices = {
        "Pauli X": [["0","1"],["1","0"]],
        "Pauli Y": [["0","-I"],["I","0"]],
        "Pauli Z": [["1","0"],["0","-1"]],
        "Hadamard": [["1","1"],["1","-1"]],
        "CNOT": [["1","0","0","0"],["0","1","0","0"],["0","0","0","1"],["0","0","1","0"]]
    };
    addMatrixField();
    var newPanelId = matrixCount;
    var mat = specialMatrices[value];
    var rowCount = mat.length;
    var colCount = mat[0].length;
    document.getElementById("rows-" + newPanelId).value = rowCount;
    document.getElementById("cols-" + newPanelId).value = colCount;
    createMatrixGrid(newPanelId, rowCount, colCount, mat);
    document.getElementById("special-matrix").value = "";
    updateExpression();
}

function populateAllHidden() {
    for (var i = 1; i <= matrixCount; i++) {
        var table = document.getElementById("grid-" + i).getElementsByTagName("table")[0];
        var text = "";
        if (table) {
            var trs = table.getElementsByTagName("tr");
            for (var j = 0; j < trs.length; j++) {
                var inputs = trs[j].getElementsByTagName("input");
                var rowText = [];
                for (var k = 0; k < inputs.length; k++) {
                    rowText.push(inputs[k].value.trim());
                }
                text += rowText.join(" ") + "\n";
            }
        }
        document.getElementById("hidden-" + i).value = text.trim();
    }
}

function updateExpression() {
    var exprFrame = document.getElementById("expression-frame");
    var op = document.getElementById("operation").value;
    var symbol = (op === "Multiply") ? "×" : (op === "Add") ? "+" : (op === "Subtract") ? "−" : "";
    var matrices = [];
    for (var i = 1; i <= matrixCount; i++) { matrices.push("M" + i); }
    exprFrame.innerHTML = matrices.join(" " + symbol + " ");
}
</script>
</body>
</html>
